---
- name: test
  gather_facts: false
  hosts: webservers
  vars:
    ansible_ssh_user: mike
  become: yes

  pre_tasks:
    - name: Validating the ssh port is open and
      wait_for:
        host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
        port: 22
        delay: 5
        timeout: 300
        state: started
        search_regex: OpenSSH

  tasks:
    - name: create test file
      copy:
        dest: /tmp/test
        content: "success"

- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ nginx —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
  hosts: webservers
  become: true
  vars:
    web_root: /var/www/html
    test_pages_dir: "{{ web_root }}/test-pages"
    
  tasks:
    
    # ========== 1. –£–°–¢–ê–ù–û–í–ö–ê NGINX ==========
    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å nginx
      apt:
        name: nginx
        state: present
        update_cache: yes

    # ========== 2. –°–û–ó–î–ê–ù–ò–ï –î–ò–†–ï–ö–¢–û–†–ò–ô ==========
    - name: –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–µ–±-—Å–∞–π—Ç–∞
      file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
      file:
        path: "{{ test_pages_dir }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    # ========== 3. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –°–¢–†–ê–ù–ò–¶ ==========
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    - name: –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      template:
        src: files/nginx/index.html
        dest: "{{ web_root }}/index.html"
        owner: www-data
        group: www-data
        mode: '0644'

    - name: –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      template:
        src: files/nginx/info.html
        dest: "{{ web_root }}/info.html"
        owner: www-data
        group: www-data
        mode: '0644'

    - name: –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ç–∞—Ç—É—Å–∞
      template:
        src: files/nginx/status.html
        dest: "{{ web_root }}/status.html"
        owner: www-data
        group: www-data
        mode: '0644'

    # –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    - name: –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      template:
        src: "{{ item }}"
        dest: "{{ test_pages_dir }}/{{ item | basename }}"
        owner: www-data
        group: www-data
        mode: '0644'
      loop:
        - files/nginx/test-pages/api-test.html
        - files/nginx/test-pages/load-test.html
        - files/nginx/test-pages/performance.html

    # ========== 4. –ù–ê–°–¢–†–û–ô–ö–ê NGINX ==========
    - name: Ensure nginx creates access logs
      lineinfile:
        path: /etc/nginx/nginx.conf
        regexp: '^(\s+)access_log'
        line: '    access_log /var/log/nginx/access.log;'
        backup: yes

    - name: Create nginx configuration
      copy:
        content: |
          server {
              listen 80;
              server_name _;
              root {{ web_root }};
              index index.html;
              
              access_log /var/log/nginx/access.log;
              error_log /var/log/nginx/error.log;
              
              # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
              location / {
                  try_files $uri $uri/ =404;
              }
              
              # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
              location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
                  expires 30d;
                  add_header Cache-Control "public, immutable";
              }
              
              # –ó–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∫—Ä—ã—Ç—ã–º —Ñ–∞–π–ª–∞–º
              location ~ /\. {
                  deny all;
              }
              
              # –¢–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
              location /health {
                  return 200 "OK\n";
                  add_header Content-Type text/plain;
              }
              
              location /metrics {
                  return 404;
              }
          }
        dest: /etc/nginx/sites-available/default
        backup: yes

    # ========== 5. –ü–†–û–í–ï–†–ö–ê –ò –ó–ê–ü–£–°–ö ==========
    - name: Test nginx configuration
      command: nginx -t
      changed_when: false

    - name: Ensure nginx log directory exists
      file:
        path: /var/log/nginx
        state: directory
        mode: '0755'
        recurse: yes

    - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
      service:
        name: nginx
        state: restarted

    # ========== 6. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ==========
    - name: Generate test traffic to create logs
      shell: |
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        for page in / /info.html /status.html /test-pages/api-test.html; do
          curl -s -o /dev/null -w "Page: $page - Status: %{http_code}\n" http://localhost$page
          sleep 1
        done
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º health endpoint
        curl -s http://localhost/health
      register: curl_test
      ignore_errors: yes

    - name: Display test results
      debug:
        var: curl_test.stdout_lines

    - name: Check nginx access logs
      shell: |
        echo "=== NGINX Logs ==="
        echo "Access log:"
        ls -la /var/log/nginx/access.log
        echo -e "\nLast 5 lines:"
        tail -5 /var/log/nginx/access.log 2>/dev/null || echo "Log is empty"
        echo -e "\nError log:"
        tail -5 /var/log/nginx/error.log 2>/dev/null || echo "No errors"
      register: log_check
      ignore_errors: yes

    - name: Display log status
      debug:
        var: log_check.stdout_lines

    # ========== 7. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ==========
    - name: Verify web server is responding
      uri:
        url: http://localhost/
        method: GET
        status_code: 200
        timeout: 10
      register: http_check

    - name: Final success message
      debug:
        msg: |
          ‚úÖ NGINX —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!
          
          üìç –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
          - http://{{ ansible_default_ipv4.address }}/ (–ì–ª–∞–≤–Ω–∞—è)
          - http://{{ ansible_default_ipv4.address }}/info.html (–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
          - http://{{ ansible_default_ipv4.address }}/status.html (–°—Ç–∞—Ç—É—Å)
          - http://{{ ansible_default_ipv4.address }}/test-pages/ (–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
          - http://{{ ansible_default_ipv4.address }}/health (Health check)
          
          üìä –õ–æ–≥–∏: /var/log/nginx/
          ‚öôÔ∏è  –ö–æ–Ω—Ñ–∏–≥: /etc/nginx/sites-available/default
