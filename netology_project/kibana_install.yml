---
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Kibana —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∑–µ—Ä–∫–∞–ª–∞ –Ø–Ω–¥–µ–∫—Å –¥–ª—è –ø–∞–∫–µ—Ç–æ–≤
  hosts: kibana
  become: yes
  vars:
    elasticsearch_host: "{{ groups.elastic[0] }}"
    kibana_version: "8.19.7"
    
  tasks:
    # ========== 1. –ù–ê–°–¢–†–û–ô–ö–ê –°–ò–°–¢–ï–ú–´ –ò –†–ï–ü–û–ó–ò–¢–û–†–ò–ï–í ==========
    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –∑–µ—Ä–∫–∞–ª–∞
      apt:
        update_cache: yes
        cache_valid_time: 3600
      environment:
        http_proxy: "http://mirror.yandex.ru"
        https_proxy: "http://mirror.yandex.ru"

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —É—Ç–∏–ª–∏—Ç
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - wget
          - gnupg
          - software-properties-common
        state: present
        update_cache: yes

    # ========== 2. –£–°–¢–ê–ù–û–í–ö–ê ELASTICSEARCH –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==========
    - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ GPG –∫–ª—é—á–∞ Elasticsearch —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
      get_url:
        url: "https://artifacts.elastic.co/GPG-KEY-elasticsearch"
        dest: /tmp/GPG-KEY-elasticsearch
        timeout: 30
        headers:
          User-Agent: "curl/7.68.0"
      register: download_gpg

    - name: –ò–º–ø–æ—Ä—Ç GPG –∫–ª—é—á–∞ Elasticsearch
      apt_key:
        file: /tmp/GPG-KEY-elasticsearch
        state: present

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Elasticsearch
      apt_repository:
        repo: "deb https://artifacts.elastic.co/packages/8.x/apt stable main"
        state: present
        filename: elastic-8.x
        update_cache: yes

    # ========== 3. –ù–ê–°–¢–†–û–ô–ö–ê APT –î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –Ø–ù–î–ï–ö–° –ö–ê–ö –ú–ò–†–†–û–†–ê ==========
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ APT –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ø–Ω–¥–µ–∫—Å –∫–∞–∫ –∑–µ—Ä–∫–∞–ª–∞
      copy:
        content: |
          Acquire::http::Proxy "http://mirror.yandex.ru:80";
          Acquire::https::Proxy "http://mirror.yandex.ru:80";
          
          # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ø–Ω–¥–µ–∫—Å –∑–µ—Ä–∫–∞–ª
          Acquire::http::Pipeline-Depth "0";
          Acquire::http::No-Cache "true";
          Acquire::BrokenProxy    "true";
        dest: /etc/apt/apt.conf.d/99yandex-mirror
        owner: root
        group: root
        mode: '0644'

    # ========== 4. –£–°–¢–ê–ù–û–í–ö–ê KIBANA ==========
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kibana (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å –∫–∞–∫ –ø—Ä–æ–∫—Å–∏)
      apt:
        name: "kibana={{ kibana_version }}"
        state: present
        update_cache: yes
        force: yes
      environment:
        http_proxy: "http://mirror.yandex.ru:80"
        https_proxy: "http://mirror.yandex.ru:80"
      register: kibana_install
      retries: 3
      delay: 10

    # ========== 5. –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò ==========
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Kibana
      command: /usr/share/kibana/bin/kibana --version
      register: kibana_version_check
      changed_when: false
      ignore_errors: yes

    - name: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ Kibana
      debug:
        msg: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è Kibana: {{ kibana_version_check.stdout }}"

    # ========== 6. –°–û–ó–î–ê–ù–ò–ï –î–ò–†–ï–ö–¢–û–†–ò–ô ==========
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è Kibana
      file:
        path: "{{ item }}"
        state: directory
        owner: kibana
        group: kibana
        mode: '0755'
      loop:
        - /etc/kibana
        - /var/lib/kibana
        - /var/log/kibana
        - /var/run/kibana

    # ========== 7. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø KIBANA ==========
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—á–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ kibana.yml
      copy:
        content: |
          # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          server.host: "0.0.0.0"
          server.port: 5601
          server.name: "kibana-server"
          
          # Elasticsearch
          elasticsearch.hosts: ["http://{{ elasticsearch_host }}:9200"]
          elasticsearch.requestTimeout: 90000
          elasticsearch.pingTimeout: 30000
          
          # –í–∞–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Kibana 8.x - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
          xpack.security.enabled: false
          
          # –ö–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (—Ç—Ä–µ–±—É—é—Ç—Å—è)
          xpack.encryptedSavedObjects.encryptionKey: "{{ 'min32charkeyforencryptionhere!' }}"
          xpack.reporting.encryptionKey: "{{ 'another32charkeyforreportinghere' }}"
          xpack.security.encryptionKey: "{{ 'security32charencryptionkeyhere!!' }}"
          
          # –û—Ç–∫–ª—é—á–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
          xpack.fleet.enabled: false
          xpack.apm.enabled: false
          xpack.ml.enabled: false
          
          # –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è
          telemetry.enabled: false
          telemetry.allowChangingOptInStatus: false
          
          # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
          elasticsearch.healthCheck.delay: 60000
          elasticsearch.skipStartupConnectionCheck: true
          
          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
          logging.dest: /var/log/kibana/kibana.log
          logging.quiet: false
          logging.verbose: false
          
          # –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
          i18n.locale: "ru"
        dest: /etc/kibana/kibana.yml
        owner: kibana
        group: kibana
        mode: '0640'
      notify:
        - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Kibana

    # ========== 8. SYSTEMD –°–õ–£–ñ–ë–ê ==========
    - name: –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–ª—É–∂–±—ã
      copy:
        content: |
          [Unit]
          Description=Kibana
          Documentation=https://www.elastic.co
          Wants=network-online.target
          After=network-online.target
          
          [Service]
          Type=simple
          User=kibana
          Group=kibana
          Environment="KBN_PATH_CONF=/etc/kibana"
          Environment="NODE_OPTIONS=--max-old-space-size=512"
          ExecStart=/usr/share/kibana/bin/kibana
          Restart=always
          RestartSec=10
          LimitNOFILE=65536
          
          # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
          PrivateTmp=true
          NoNewPrivileges=true
          ProtectSystem=strict
          ReadWritePaths=/var/lib/kibana /var/log/kibana /var/run/kibana
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/kibana.service
        owner: root
        group: root
        mode: '0644'

    # ========== 9. –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ê–í ==========
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–ª—è Kibana
      shell: |
        chown -R kibana:kibana /etc/kibana
        chown -R kibana:kibana /var/lib/kibana
        chown -R kibana:kibana /var/log/kibana
        chown -R kibana:kibana /var/run/kibana
        chmod 750 /var/lib/kibana
        chmod 750 /var/log/kibana
      changed_when: false

    # ========== 10. –ó–ê–ü–£–°–ö –°–õ–£–ñ–ë–´ ==========
    - name: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd
      systemd:
        daemon_reload: yes

    - name: –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ Kibana
      systemd:
        name: kibana
        enabled: yes

    - name: –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã Kibana
      systemd:
        name: kibana
        state: started

    # ========== 11. –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–ü–£–°–ö–ê ==========
    - name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Kibana (60 —Å–µ–∫—É–Ω–¥)
      pause:
        seconds: 60
        prompt: "Kibana –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è... –ü–æ–¥–æ–∂–¥–∏—Ç–µ 60 —Å–µ–∫—É–Ω–¥"

    # ========== 12. –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø ==========
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Kibana
      shell: |
        echo "=== –ü–†–û–í–ï–†–ö–ê KIBANA ==="
        echo ""
        echo "1. –°–¢–ê–¢–£–° –°–õ–£–ñ–ë–´:"
        systemctl is-active kibana && echo "‚úì –ê–∫—Ç–∏–≤–Ω–∞" || echo "‚úó –ù–µ–∞–∫—Ç–∏–≤–Ω–∞"
        echo ""
        echo "2. –ü–†–û–¶–ï–°–°–´:"
        ps aux | grep kibana | grep -v grep | wc -l | xargs echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:"
        echo ""
        echo "3. –ü–û–†–¢:"
        timeout 2 bash -c "echo > /dev/tcp/localhost/5601" 2>/dev/null && echo "‚úì –ü–æ—Ä—Ç 5601 –æ—Ç–∫—Ä—ã—Ç" || echo "‚úó –ü–æ—Ä—Ç 5601 –∑–∞–∫—Ä—ã—Ç"
        echo ""
        echo "4. –õ–û–ì–ò (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫):"
        journalctl -u kibana -n 5 --no-pager 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
        echo ""
        echo "5. –û–®–ò–ë–ö–ò:"
        journalctl -u kibana --since "1 minute ago" --no-pager 2>/dev/null | grep -i "error\|fatal\|failed" || echo "–û—à–∏–±–æ–∫ –Ω–µ—Ç"
      register: status_check
      changed_when: false

    - name: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
      debug:
        msg: "{{ status_check.stdout_lines }}"

    # ========== 13. –ü–†–û–í–ï–†–ö–ê API ==========
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API Kibana
      uri:
        url: "http://localhost:5601/api/status"
        method: GET
        timeout: 30
        status_code: 200
        validate_certs: no
      register: api_test
      ignore_errors: yes
      retries: 10
      delay: 6
      until: api_test.status == 200

    # ========== 14. –£–î–ê–õ–ï–ù–ò–ï –ü–†–û–ö–°–ò –ù–ê–°–¢–†–û–ô–ö–ò APT ==========
    - name: –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ APT (–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
      file:
        path: /etc/apt/apt.conf.d/99yandex-mirror
        state: absent
      ignore_errors: yes

    # ========== 15. –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ ==========
    - block:
        - name: –£—Å–ø–µ—à–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
          debug:
            msg: |
              üéâ KIBANA –£–°–ü–ï–®–ù–û –£–°–¢–ê–ù–û–í–õ–ï–ù!
              
              üåê –î–æ—Å—Ç—É–ø –ø–æ –∞–¥—Ä–µ—Å—É:
              http://{{ ansible_default_ipv4.address }}:5601
              
              üîó Elasticsearch:
              {{ elasticsearch_host }}:9200
              
              üìä –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
              curl http://localhost:5601/api/status
              
              ‚öôÔ∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
              /etc/kibana/kibana.yml
              
              üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑: Elastic —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å
      when: api_test.status == 200

    - block:
        - name: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
          debug:
            msg: |
              ‚ö†Ô∏è  –ü–†–û–ë–õ–ï–ú–´ –° –ó–ê–ü–£–°–ö–û–ú KIBANA
              
              –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
              
              1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
                 sudo journalctl -u kibana -f
              
              2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
                 sudo cat /etc/kibana/kibana.yml
              
              3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å:
                 ps aux | grep kibana
              
              4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç:
                 netstat -tlnp | grep 5601
              
              5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Elasticsearch:
                 curl {{ elasticsearch_host }}:9200
              
              ‚è±Ô∏è  –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ 2-3 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞
              
              üìç –ê–¥—Ä–µ—Å: http://{{ ansible_default_ipv4.address }}:5601
      when: api_test.status != 200

    # ========== 16. –û–ß–ò–°–¢–ö–ê ==========
    - name: –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      file:
        path: /tmp/GPG-KEY-elasticsearch
        state: absent

    - name: –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ APT
      apt:
        autoclean: yes
        autoremove: yes

  handlers:
    - name: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd
      systemd:
        daemon_reload: yes

    - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Kibana
      systemd:
        name: kibana
        state: restarted
